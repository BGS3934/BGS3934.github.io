<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>v3 Mixed Reality Tetris</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- Load aframe-extras for physics support -->
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v3.3.0/dist/aframe-physics-system.min.js"></script>
</head>
<body>
  <a-scene xrweb="arMode: true" physics="gravity: -9.8; debug: false">

    <!-- Camera and lighting -->
    <a-light type="ambient" color="#ffffff" intensity="0.5"></a-light>
    <a-light type="directional" position="1 2 0" intensity="1"></a-light>
    <a-camera position="0 1.6 0"></a-camera>

    <!-- Debug text for controller inputs -->
    <a-text value="Controller Input: " position="-0.5 2 -3" id="debug-text" color="black"></a-text>

    <!-- Container for blocks -->
    <a-entity id="block-container"></a-entity>

    <script>
      // Controller Variables
      let rotation = 0;
      let positionX = 0;
      let dropSpeed = 1;
      let activeBlock;
      let blockDropping = false;
      const blockSize = 0.5;
      const blockDropHeight = 5;

      // Create a new block
      function createBlock() {
        activeBlock = document.createElement('a-entity');
        activeBlock.setAttribute('position', `${positionX} ${blockDropHeight} -3`);
        activeBlock.setAttribute('geometry', {
          primitive: 'box',
          width: blockSize,
          height: blockSize,
          depth: blockSize
        });
        activeBlock.setAttribute('material', {
          color: getRandomColor()
        });
        activeBlock.setAttribute('dynamic-body', 'shape: box; mass: 1');  // Physics applied
        activeBlock.setAttribute('rotation', `0 ${rotation} 0`);
        document.getElementById('block-container').appendChild(activeBlock);
        blockDropping = true;
      }

      // Function to get a random color
      function getRandomColor() {
        const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];
        return colors[Math.floor(Math.random() * colors.length)];
      }

      // Function to rotate and move blocks
      function handleControllerInput(evt) {
        const debugText = document.getElementById('debug-text');
        const gamepad = evt.target.components['tracked-controls'].controller;
        
        // Update debug text
        debugText.setAttribute('value', `Controller Input: ${gamepad.buttons[0].pressed ? 'Trigger pressed' : ''}`);

        // Check for button presses and modify the block accordingly
        if (gamepad.buttons[0].pressed) {  // Trigger button (drops faster)
          dropSpeed = 5;
        } else {
          dropSpeed = 1;
        }

        // Move left (X button)
        if (gamepad.buttons[1].pressed) {
          positionX -= 0.1;
          activeBlock.setAttribute('position', `${positionX} ${blockDropHeight} -3`);
        }
        
        // Move right (Y button)
        if (gamepad.buttons[2].pressed) {
          positionX += 0.1;
          activeBlock.setAttribute('position', `${positionX} ${blockDropHeight} -3`);
        }

        // Rotate left (A button)
        if (gamepad.buttons[3].pressed) {
          rotation -= 15;
          activeBlock.setAttribute('rotation', `0 ${rotation} 0`);
        }

        // Rotate right (B button)
        if (gamepad.buttons[4].pressed) {
          rotation += 15;
          activeBlock.setAttribute('rotation', `0 ${rotation} 0`);
        }
      }

      // Continuously drop the block
      setInterval(() => {
        if (blockDropping && activeBlock) {
          let currentPosition = activeBlock.getAttribute('position');
          if (currentPosition.y > 0) {
            activeBlock.setAttribute('position', `${currentPosition.x} ${currentPosition.y - dropSpeed * 0.01} ${currentPosition.z}`);
          } else {
            blockDropping = false;
            dropSpeed = 1;
            createBlock();  // Start the next block after it lands
          }
        }
      }, 100);

      // Listen for controller events
      document.querySelector('a-scene').addEventListener('controllerconnected', (evt) => {
        evt.target.addEventListener('axismove', handleControllerInput);
      });

      // Start the first block
      createBlock();
    </script>
  </a-scene>
</body>
</html>

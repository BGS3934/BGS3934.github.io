<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>v2 Mixed Reality Tetris</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
</head>
<body>
  <a-scene xrweb="arMode: true" physics="debug: true">

    <!-- Camera and lighting -->
    <a-light type="ambient" color="#ffffff" intensity="0.5"></a-light>
    <a-light type="directional" position="1 2 0" intensity="1"></a-light>
    <a-camera position="0 1.6 0"></a-camera>

    <!-- Debug text for controller inputs -->
    <a-text value="Controller Input: " position="-0.5 2 -3" id="debug-text" color="black"></a-text>

    <a-entity id="block-container"></a-entity>

    <script>
      // Controller Variables
      let rotation = 0;
      let positionX = 0;
      let dropSpeed = 1;
      let activeBlock;
      const blockSize = 0.5;
      let blockDropping = false;

      // Create a new block
      function createBlock() {
        activeBlock = document.createElement('a-entity');
        activeBlock.setAttribute('position', `${positionX} 5 -3`);
        activeBlock.setAttribute('geometry', {
          primitive: 'box',
          width: blockSize,
          height: blockSize,
          depth: blockSize
        });
        activeBlock.setAttribute('material', {
          color: getRandomColor()
        });
        activeBlock.setAttribute('dynamic-body', 'shape: box; mass: 1');
        activeBlock.setAttribute('rotation', `0 ${rotation} 0`);
        document.getElementById('block-container').appendChild(activeBlock);
        blockDropping = true;
      }

      // Function to get a random color
      function getRandomColor() {
        const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];
        return colors[Math.floor(Math.random() * colors.length)];
      }

      // Function to rotate and move blocks
      function handleControllerInput(evt) {
        const debugText = document.getElementById('debug-text');
        if (evt.detail.name === 'bbuttondown') {
          rotation += 90;
          activeBlock.setAttribute('rotation', `0 ${rotation} 0`);
          debugText.setAttribute('value', 'Controller Input: Rotating Block');
        } else if (evt.detail.name === 'abuttondown') {
          rotation -= 90;
          activeBlock.setAttribute('rotation', `0 ${rotation} 0`);
          debugText.setAttribute('value', 'Controller Input: Rotating Block (Reverse)');
        } else if (evt.detail.name === 'xbuttondown') {
          positionX -= 1;
          activeBlock.setAttribute('position', `${positionX} 5 -3`);
          debugText.setAttribute('value', 'Controller Input: Moving Left');
        } else if (evt.detail.name === 'ybuttondown') {
          positionX += 1;
          activeBlock.setAttribute('position', `${positionX} 5 -3`);
          debugText.setAttribute('value', 'Controller Input: Moving Right');
        } else if (evt.detail.name === 'triggerdown') {
          dropSpeed = 5;
          debugText.setAttribute('value', 'Controller Input: Dropping Faster');
        }
      }

      // Listen for controller events
      document.addEventListener('bbuttondown', handleControllerInput);
      document.addEventListener('abuttondown', handleControllerInput);
      document.addEventListener('xbuttondown', handleControllerInput);
      document.addEventListener('ybuttondown', handleControllerInput);
      document.addEventListener('triggerdown', handleControllerInput);

      // Continuously drop the block
      setInterval(() => {
        if (blockDropping && activeBlock) {
          let currentPosition = activeBlock.getAttribute('position');
          if (currentPosition.y > 0) {
            activeBlock.setAttribute('position', `${currentPosition.x} ${currentPosition.y - dropSpeed * 0.01} ${currentPosition.z}`);
          } else {
            blockDropping = false;
            dropSpeed = 1;
            createBlock();  // Start the next block after it lands
          }
        }
      }, 100);

      // Start the first block
      createBlock();
    </script>
  </a-scene>
</body>
</html>
